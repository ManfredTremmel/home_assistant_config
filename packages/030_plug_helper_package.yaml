# ############ HA helpers for power plugs ############
#
# (C) 2025 Manfred Tremmel
#
# I've installed some Zigbee power plugs and sensors and
# here are some helpers defined
#
# Dependencies:
#       "kodi" extension
#       "AVM FRITZ!SmartHome" extension
#       "Appliance has finished" blueprint
#       "000_kodi_package.yaml" (not in git repository contains user and password)
#       "020_solar_grid_limitation_package.yaml"
#
# Used entities:
#       sensor.steckdose_ug_waschmaschine_power
#       sensor.steckdose_eg_geschirrspuhler_power
#       sensor.steckdose_garage_power
#       switch.steckdose_ug_waschmaschine
#       switch.steckdose_eg_geschirrspuhler
#       switch.steckdose_garage
#       binary_sensor.wassersensor_ug_technikraum_water_leak
#       binary_sensor.wassersensor_ug_kellerraum_water_leak
#       binary_sensor.wassersensor_ug_fittnesraum_water_leak
#       binary_sensor.wassersensor_ug_werkstatt_water_leak
#       binary_sensor.rauchmelder_ug_fittnesraum_smoke
#       sensor.solar_power_generators_sum
#
# Provided entities:
#       binary_sensor.waschmaschine
#       binary_sensor.geschirrspuelmaschine
#       binary_sensor.eroller
#
#
template:
  - binary_sensor:

    # sensor indicates washing machine is running or not
    - unique_id: "waschmaschine"
      name: "Waschmaschine"
      state: ""
      device_class: running
      icon: mdi:washing-machine
    # sensor indicates dishwasher is running or not
    - unique_id: "geschirrspulmaschine"
      name: "Geschirrspülmaschine"
      state: ""
      device_class: running
      icon: mdi:dishwasher
    # sensor indicates electric mpoed is loading or not
    - unique_id: "eroller"
      name: "eRoller"
      state: ""
      device_class: battery_charging
      icon: mdi:moped-electric

automation power_plug_helpers:

  # prüfe, ob die Waschmaschine läuft
  - id: "waschmaschine_statusbenachrichtigung"
    alias: "Waschmaschine Statusbenachrichtigung"
    description: ""
    use_blueprint:
      path: sbyx/notify-or-do-something-when-an-appliance-like-a-dishwasher-or-washing-machine-finishes.yaml
      input:
        power_sensor: sensor.steckdose_ug_waschmaschine_power
        starting_threshold: 20
        starting_hysteresis: 3
        finishing_threshold: 50
        finishing_hysteresis: 4
        actions:
        - action: notify.kodi_t470
          data:
            title: "Waschmaschine ist fertig"
            message: "Die Waschmaschine kann geleert werden"
            data:
              displaytime: 20000
              icon: "info"
        - action: notify.kodi_libreelec_eg2
          data:
            title: "Waschmaschine ist fertig"
            message: "Die Waschmaschine kann geleert werden"
            data:
              displaytime: 20000
              icon: "info"
        - action: python_script.set_state
          data:
            entity_id: binary_sensor.waschmaschine
            state: "off"
        pre_actions:
        - action: python_script.set_state
          data:
            entity_id: binary_sensor.waschmaschine
            state: "on"

  # Prüfe, ob die Geschirrspülmaschine läuft
  - id: "geschirrspulmaschine_statusbenachrichtigung"
    alias: "Geschirrspülmaschine Statusbenachrichtigung"
    description: ""
    use_blueprint:
      path: sbyx/notify-or-do-something-when-an-appliance-like-a-dishwasher-or-washing-machine-finishes.yaml
      input:
        power_sensor: sensor.steckdose_eg_geschirrspuhler_power
        starting_threshold: 10
        starting_hysteresis: 3
        finishing_threshold: 2
        finishing_hysteresis: 2
        actions:
        - action: notify.kodi_t470
          data:
            title: "Geschirrspüler ist fertig"
            message: "Die Geschirrspülmaschine kann geleert werden"
            data:
              displaytime: 20000
              icon: "info"
        - action: notify.kodi_libreelec_eg2
          data:
            title: "Geschirrspüler ist fertig"
            message: "Die Geschirrspülmaschine kann geleert werden"
            data:
              displaytime: 20000
              icon: "info"
        - action: python_script.set_state
          data:
            entity_id: binary_sensor.geschirrspulmaschine
            state: "off"
        pre_actions:
        - action: python_script.set_state
          data:
            entity_id: binary_sensor.geschirrspulmaschine
            state: "on"

  # Prüfe, ob der eRoller gerade geladen wird
  - id: "eroller_statusbenachrichtigung"
    alias: "eRoller Statusbenachrichtigung"
    description: ""
    use_blueprint:
      path: sbyx/notify-or-do-something-when-an-appliance-like-a-dishwasher-or-washing-machine-finishes.yaml
      input:
        power_sensor: sensor.steckdose_garage_power
        starting_threshold: 3
        starting_hysteresis: 2
        finishing_threshold: 3
        finishing_hysteresis: 2
        actions:
        - action: notify.kodi_t470
          data:
            title: "Roller ist geladen"
            message: "Der eRoller ist fertig geladen"
            data:
              displaytime: 20000
              icon: "info"
        - action: notify.kodi_libreelec_eg2
          data:
            title: "Roller ist geladen"
            message: "Der eRoller ist fertig geladen"
            data:
              displaytime: 20000
              icon: "info"
        - action: python_script.set_state
          data:
            entity_id: binary_sensor.eroller
            state: "off"
        pre_actions:
        - action: python_script.set_state
          data:
            entity_id: binary_sensor.eroller
            state: "on"

  # Sende Meldungen, wenn einer der Wasser-Sensoren im Keller Alarm schlägt
  - id: "wasser_im_keller_technikraum"
    alias: "Wasser im Keller Technikraum"
    description: "Der Wassersensor meldet Wasser im Technikraum"
    triggers:
    - trigger: state
      entity_id:
      - binary_sensor.wassersensor_ug_technikraum_water_leak
      to: "on"
    actions:
      - action: switch.turn_off
        target:
          entity_id: switch.steckdose_ug_waschmaschine
      - action: notify.kodi_t470
        data:
          title: 'Wasser im Keller'
          message: 'Der Wassersensor im Technikraum meldet Wasser!'
          data:
            displaytime: 50000
            icon: error
      - action: notify.kodi_libreelecmanfred
        data:
          title: 'Wasser im Keller'
          message: 'Der Wassersensor im Technikraum meldet Wasser!'
          data:
            displaytime: 50000
            icon: error
      - action: notify.kodi_libreelec_eg2
        data:
          title: 'Wasser im Keller'
          message: 'Der Wassersensor im Technikraum meldet Wasser!'
          data:
            displaytime: 50000
            icon: error
      - action: button.press
        target:
          entity_id: button.anrufhawasserugtechnik

  - id: "wasser_im_keller_kellerraum"
    alias: "Wasser im Keller Kellerraum"
    description: "Der Wassersensor meldet Wasser im Kellerraum"
    triggers:
    - trigger: state
      entity_id:
      - binary_sensor.wassersensor_ug_kellerraum_water_leak
      to: "on"
    actions:
      - action: notify.kodi_t470
        data:
          title: 'Wasser im Keller'
          message: 'Der Wassersensor im Kellerraum meldet Wasser!'
          data:
            displaytime: 50000
            icon: error
      - action: notify.kodi_libreelecmanfred
        data:
          title: 'Wasser im Keller'
          message: 'Der Wassersensor im Kellerraum meldet Wasser!'
          data:
            displaytime: 50000
            icon: error
      - action: notify.kodi_libreelec_eg2
        data:
          title: 'Wasser im Keller'
          message: 'Der Wassersensor im Kellerraum meldet Wasser!'
          data:
            displaytime: 50000
            icon: error
      - action: button.press
        target:
          entity_id: button.anrufhawasserugkeller

  - id: "wasser_im_keller_fittnesraum"
    alias: "Wasser im Keller Fittnesraum"
    description: "Der Wassersensor meldet Wasser im Fittnesraum"
    triggers:
    - trigger: state
      entity_id:
      - binary_sensor.wassersensor_ug_fittnesraum_water_leak
      to: "on"
    actions:
      - action: switch.turn_off
        target:
          entity_id: switch.steckdose_ug_hauswasserwerk
      - action: notify.kodi_t470
        data:
          title: 'Wasser im Keller'
          message: 'Der Wassersensor im Fittnesraum meldet Wasser!'
          data:
            displaytime: 50000
            icon: error
      - action: notify.kodi_libreelecmanfred
        data:
          title: 'Wasser im Keller'
          message: 'Der Wassersensor im Fittnesraum meldet Wasser!'
          data:
            displaytime: 50000
            icon: error
      - action: notify.kodi_libreelec_eg2
        data:
          title: 'Wasser im Keller'
          message: 'Der Wassersensor im Fittnesraum meldet Wasser!'
          data:
            displaytime: 50000
            icon: error
      - action: button.press
        target:
          entity_id: button.anrufhawasserugfitness

  - id: "wasser_im_keller_werkstatt"
    alias: "Wasser im Keller Werkstatt"
    description: "Der Wassersensor meldet Wasser im Werkstatt"
    triggers:
    - trigger: state
      entity_id:
      - binary_sensor.wassersensor_ug_werkstatt_water_leak
      to: "on"
    actions:
      - action: notify.kodi_t470
        data:
          title: 'Wasser im Keller'
          message: 'Der Wassersensor im Werkstatt meldet Wasser!'
          data:
            displaytime: 50000
            icon: error
      - action: notify.kodi_libreelecmanfred
        data:
          title: 'Wasser im Keller'
          message: 'Der Wassersensor im Werkstatt meldet Wasser!'
          data:
            displaytime: 50000
            icon: error
      - action: notify.kodi_libreelec_eg2
        data:
          title: 'Wasser im Keller'
          message: 'Der Wassersensor im Werkstatt meldet Wasser!'
          data:
            displaytime: 50000
            icon: error
      - action: button.press
        target:
          entity_id: button.anrufhawasserugwerkstatt

  # Rauchmelder im Keller hat Alarm geschlagen
  - id: "rauch_im_keller_fittnesraum"
    alias: "Rauch im Keller Fittnesraum"
    description: "Der Rauchmelder meldet Rauch im Fittnesraum"
    triggers:
    - trigger: state
      entity_id:
      - binary_sensor.rauchmelder_ug_fittnesraum_smoke
      to: "on"
    actions:
      - action: notify.kodi_t470
        data:
          title: 'Rauch im Keller'
          message: 'Der Rauchmelder meldet Rauch im Fittnesraum!'
          data:
            displaytime: 50000
            icon: error
      - action: notify.kodi_libreelecmanfred
        data:
          title: 'Rauch im Keller'
          message: 'Der Rauchmelder meldet Rauch im Fittnesraum!'
          data:
            displaytime: 50000
            icon: error
      - action: notify.kodi_libreelec_eg2
        data:
          title: 'Rauch im Keller'
          message: 'Der Rauchmelder meldet Rauch im Fittnesraum!'
          data:
            displaytime: 50000
            icon: error
      - action: button.press
        target:
          entity_id: button.anrufharauchugfitness

  # Turn on garage plug, when pv power is more then 2 kW
  - id: "turn_on_garage_plug_when_sun_shines"
    alias: "Turn on garage plug when sun shines"
    description: "Sobald mehr als 2 kW PV Leistung anliegt, Garagen Plug aktivieren"
    triggers:
      - trigger: numeric_state
        entity_id:
        - sensor.solar_power_generators_sum
        above: 2000
        for:
          hours: 0
          minutes: 5
          seconds: 0
    conditions:
      - condition: state
        entity_id: "switch.steckdose_garage"
        state: "off"
    actions:
      - action: switch.turn_on
        target:
          entity_id: "switch.steckdose_garage"
    mode: single

  # Turn off garage plug, when pv power is less then 1.5 kW
  - id: "turn_off_garage_plug_when_sun_doesnt_shines"
    alias: "Turn off garage plug when sun doesnt shines"
    description: "Sobald weniger als 1,5 kW PV Leistung anliegt, Garagen Plug deaktivieren"
    triggers:
      - trigger: numeric_state
        entity_id:
        - sensor.solar_power_generators_sum
        below: 1500
        for:
          hours: 0
          minutes: 5
          seconds: 0
    conditions:
      - condition: state
        entity_id: "switch.steckdose_garage"
        state: "on"
    actions:
      - action: switch.turn_off
        target:
          entity_id: "switch.steckdose_garage"
    mode: single
