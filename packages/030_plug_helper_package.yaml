# ############ HA helpers for power plugs ############
#
# (C) 2025 Manfred Tremmel
#
# I've installed some Zigbee power plugs and sensors and
# here are some helpers defined
#
# Dependencies:
#       "kodi" extension
#       "AVM FRITZ!SmartHome" extension
#       "Appliance has finished" blueprint
#       "000_kodi_package.yaml"
#       "010_notify_groups.yaml"
#       "020_solar_grid_limitation_package.yaml"
#
# Used entities:
#       sensor.steckdose_ug_waschmaschine_power
#       sensor.steckdose_eg_geschirrspuhler_power
#       sensor.steckdose_garage_power
#       switch.steckdose_ug_waschmaschine
#       switch.steckdose_eg_geschirrspuhler
#       switch.steckdose_garage
#       binary_sensor.wassersensor_ug_technikraum_water_leak
#       binary_sensor.wassersensor_ug_kellerraum_water_leak
#       binary_sensor.wassersensor_ug_fittnesraum_water_leak
#       binary_sensor.wassersensor_ug_werkstatt_water_leak
#       binary_sensor.rauchmelder_ug_fittnesraum_smoke
#       binary_sensor.rauchmelder_eg_schlafzimmer_smoke
#       sensor.solar_power_generators_sum
#
# Provided entities:
#       binary_sensor.waschmaschine
#       binary_sensor.geschirrspuelmaschine
#       binary_sensor.eroller
#
#
template:
  - binary_sensor:

    # sensor indicates washing machine is running or not
    - unique_id: "waschmaschine"
      name: "Waschmaschine"
      state: ""
      device_class: running
      icon: mdi:washing-machine
    # sensor indicates dishwasher is running or not
    - unique_id: "geschirrspulmaschine"
      name: "Geschirrsp√ºlmaschine"
      state: ""
      device_class: running
      icon: mdi:dishwasher
    # sensor indicates electric mpoed is loading or not
    - unique_id: "eroller"
      name: "eRoller"
      state: ""
      device_class: battery_charging
      icon: mdi:moped-electric

automation power_plug_helpers:

  # pr√ºfe, ob die Waschmaschine l√§uft
  - id: "waschmaschine_statusbenachrichtigung"
    alias: "Waschmaschine Statusbenachrichtigung"
    description: ""
    use_blueprint:
      path: sbyx/notify-or-do-something-when-an-appliance-like-a-dishwasher-or-washing-machine-finishes.yaml
      input:
        power_sensor: sensor.steckdose_ug_waschmaschine_power
        starting_threshold: 20
        starting_hysteresis: 3
        finishing_threshold: 50
        finishing_hysteresis: 4
        actions:
        - action: notify.all_devices
          data:
            title: "Waschmaschine ist fertig"
            message: "Die Waschmaschine kann geleert werden"
            data:
              expire: 20000
              displaytime: 20000
              urgency: normal
              icon: "info"
        - action: python_script.set_state
          data:
            entity_id: binary_sensor.waschmaschine
            state: "off"
        pre_actions:
        - action: python_script.set_state
          data:
            entity_id: binary_sensor.waschmaschine
            state: "on"

  # Pr√ºfe, ob die Geschirrsp√ºlmaschine l√§uft
  - id: "geschirrspulmaschine_statusbenachrichtigung"
    alias: "Geschirrsp√ºlmaschine Statusbenachrichtigung"
    description: ""
    use_blueprint:
      path: sbyx/notify-or-do-something-when-an-appliance-like-a-dishwasher-or-washing-machine-finishes.yaml
      input:
        power_sensor: sensor.steckdose_eg_geschirrspuhler_power
        starting_threshold: 10
        starting_hysteresis: 3
        finishing_threshold: 2
        finishing_hysteresis: 2
        actions:
        - action: notify.all_devices
          data:
            title: "Geschirrsp√ºler ist fertig"
            message: "Die Geschirrsp√ºlmaschine kann geleert werden"
            data:
              expire: 20000
              displaytime: 20000
              urgency: normal
              icon: "info"
        - action: python_script.set_state
          data:
            entity_id: binary_sensor.geschirrspulmaschine
            state: "off"
        pre_actions:
        - action: python_script.set_state
          data:
            entity_id: binary_sensor.geschirrspulmaschine
            state: "on"

  # Pr√ºfe, ob der eRoller gerade geladen wird
  - id: "eroller_statusbenachrichtigung"
    alias: "eRoller Statusbenachrichtigung"
    description: ""
    use_blueprint:
      path: sbyx/notify-or-do-something-when-an-appliance-like-a-dishwasher-or-washing-machine-finishes.yaml
      input:
        power_sensor: sensor.steckdose_garage_power
        starting_threshold: 3
        starting_hysteresis: 2
        finishing_threshold: 3
        finishing_hysteresis: 2
        actions:
        - action: notify.all_devices
          data:
            title: "Roller ist geladen"
            message: "Der eRoller ist fertig geladen"
            data:
              expire: 20000
              displaytime: 20000
              urgency: normal
              icon: "info"
        - action: python_script.set_state
          data:
            entity_id: binary_sensor.eroller
            state: "off"
        pre_actions:
        - action: python_script.set_state
          data:
            entity_id: binary_sensor.eroller
            state: "on"

  # Wassermelder Alarm
  - id: "wassermelder_alarm"
    alias: "Wassermelder Alarm"
    description: "Einer der Wassermelder schl√§gt Alarm"
    triggers:
    - trigger: state
      entity_id:
      - binary_sensor.wassersensor_ug_werkstatt_water_leak
      - binary_sensor.wassersensor_ug_fittnesraum_water_leak
      - binary_sensor.wassersensor_ug_kellerraum_water_leak
      - binary_sensor.wassersensor_ug_technikraum_water_leak
      to: "on"
    actions:
      - action: notify.all_devices
        data:
          title: 'Wassermelder Warnung!'
          message: 'üíß Wassermelder {{ trigger.to_state.name }} schl√§gt Alarm! üíß'
          data:
            expire: 50000
            displaytime: 50000
            urgency: critical
            icon: error
      - action: select.select_option
        target:
          entity_id:
            - select.rauchmelder_eg_schlafzimmer_buzzer
        data:
          option: alarm
      - action: button.press
        target:
          entity_id: button.anrufhawasser

  # Rauchmelder Alarm
  - id: "rauchmelder_alarm"
    alias: "Rauchmelder Alarm"
    description: "Einer der Rauchmelder schl√§gt Alarm"
    triggers:
    - trigger: state
      entity_id:
      - binary_sensor.rauchmelder_eg_schlafzimmer_smoke
      - binary_sensor.rauchmelder_ug_fittnesraum_smoke
      to: "on"
    actions:
      - action: notify.all_devices
        data:
          title: 'Rauchmelder Warnung!'
          message: 'üî• Rauchmelder {{ trigger.to_state.name }} schl√§gt Alarm! üî•'
          data:
            expire: 50000
            displaytime: 50000
            urgency: critical
            icon: error
      - action: select.select_option
        target:
          entity_id:
            - select.rauchmelder_eg_schlafzimmer_buzzer
        data:
          option: alarm
      - action: button.press
        target:
          entity_id: button.anrufharauchmelder

  # Turn on garage plug, when pv power is more then 2 kW
  - id: "turn_on_garage_plug_when_sun_shines"
    alias: "Turn on garage plug when sun shines"
    description: "Sobald mehr als 2 kW PV Leistung anliegt, Garagen Plug aktivieren"
    triggers:
      - trigger: numeric_state
        entity_id:
        - sensor.solar_power_generators_sum
        above: 2000
        for:
          hours: 0
          minutes: 5
          seconds: 0
    conditions:
      - condition: state
        entity_id: "switch.steckdose_garage"
        state: "off"
    actions:
      - action: switch.turn_on
        target:
          entity_id: "switch.steckdose_garage"
    mode: single

  # Turn off garage plug, when pv power is less then 1.5 kW
  - id: "turn_off_garage_plug_when_sun_doesnt_shines"
    alias: "Turn off garage plug when sun doesnt shines"
    description: "Sobald weniger als 1,5 kW PV Leistung anliegt, Garagen Plug deaktivieren"
    triggers:
      - trigger: numeric_state
        entity_id:
        - sensor.solar_power_generators_sum
        below: 1500
        for:
          hours: 0
          minutes: 5
          seconds: 0
    conditions:
      - condition: state
        entity_id: "switch.steckdose_garage"
        state: "on"
    actions:
      - action: switch.turn_off
        target:
          entity_id: "switch.steckdose_garage"
    mode: single

  # cat bell, send message when sensor detects cat in front of the door
  - id: cat_bell_message
    alias: "Cat Bell Message"
    description: "Katzenklingelbenachrichtigung"
    triggers:
      - trigger: state
        entity_id:
        - binary_sensor.katzenklingel_water_leak
        to:
          - "on"
        from:
          - "off"
        for:
          hours: 0
          minutes: 0
          seconds: 3
    conditions: []
    actions:
      - action: notify.all_mobiles
        metadata: {}
        data:
          title: "Katzenklingel"
          message: "Miko steht vor der T√ºre üêà"
          data:
            expire: 20000
            urgency: normal
            icon: cat
      - action: notify.all_kodies
        data:
          title: "Katzenklingel"
          message: "Miko steht vor der T√ºre"
          data:
            displaytime: 20000
            icon: "info"
      - action: button.press
        target:
          entity_id: button.anrufhakatzenklingel
    mode: single
